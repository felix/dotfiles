#!/bin/sh

cachedir=${XDG_CACHE_HOME:-"$HOME/.cache"}
[ ! -d "$cachedir" ] && mkdir $cachedir
cache=$cachedir/dmenu_cache
recent="$cachedir/dmenu_recent"
most_used=$(sort $recent 2>/dev/null |uniq -c |sort -rn |awk '{print $2}')

IFS=:
if stest -dqr -n "$cache" $PATH; then
    stest -flx $PATH | sort -u >"$cache"
fi

# Combine the recent with cache and pass to dmenu
run=$((echo "$most_used" "\n---"; cat "$cache") |dmenu -l 10 -p Run: "$@") || exit

# Run with shell if terminated with semi-colon
case $run in
    *\;) ${SHELL:-"/bin/sh"} ${run%%;} &
        ;;
    *)   $run &
        ;;
esac

# Clean recent keeping last 20 entries
(echo $run; head -n 20 $recent 2>/dev/null) > $recent.$$ && mv $recent.$$ $recent

exit 0
